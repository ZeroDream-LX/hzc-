<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AI助手小言</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        body {
            /* 深色背景渐变 */
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            position: relative;
            min-height: 100vh;
            padding: 20px 0; /* 上下内边距，避免内容贴边 */
        }

        /* 背景模糊层（增强深色层次感） */
        .bck-filter {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 15, 30, 0.8);
            backdrop-filter: blur(10px);
            z-index: -1;
        }

        /* 主容器：限制最大宽度+居中+半透明+毛玻璃 */
        .container {
            max-width: 800px; /* 限制最大宽度，可根据需求调整为768/900px */
            width: 90%; /* 自适应宽度，移动端占90% */
            margin: 0 auto; /* 居中 */
            height: calc(100vh - 40px); /* 减去body的上下内边距 */
            display: flex;
            flex-direction: column;
            background: rgba(25, 30, 50, 0.6); /* 半透明深色背景 */
            backdrop-filter: blur(15px); /* 毛玻璃效果 */
            border-radius: 12px; /* 圆角 */
            border: 1px solid rgba(255, 255, 255, 0.1); /* 浅边框增强层次 */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); /* 阴影增强立体感 */
            overflow: hidden; /* 隐藏溢出内容 */
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            margin-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #444 #222; /* 深色滚动条 */
        }

        /* 滚动条样式（深色适配） */
        .main::-webkit-scrollbar {
            width: 6px;
        }

        .main::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 3px;
        }

        .main::-webkit-scrollbar-track {
            background-color: #222;
        }

        /* 对话样式 */
        .ai, .people {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            padding: 0 10px;
        }

        .ai img, .people img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.1); /* 头像边框 */
        }

        .ai img {
            margin-right: 12px;
        }

        .people {
            flex-direction: row-reverse;
        }

        .people img {
            margin-left: 12px;
        }

        .answer {
            max-width: 70%;
            background: rgba(35, 45, 70, 0.8); /* 半透明气泡背景 */
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            backdrop-filter: blur(5px); /* 气泡毛玻璃 */
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* AI对话气泡颜色 */
        .ai .answer {
            background: rgba(40, 60, 100, 0.8);
            border-top-left-radius: 4px;
        }

        /* 用户对话气泡颜色 */
        .people .answer {
            background: rgba(60, 30, 80, 0.8);
            border-top-right-radius: 4px;
        }

        .answer span:first-child {
            display: block;
            font-size: 12px;
            color: #999; /* 浅色时间文字 */
            margin-bottom: 6px;
        }

        .answer span:last-child {
            font-size: 14px;
            line-height: 1.5;
            color: #e5e5e5; /* 浅色主文字 */
        }

        /* 输入区域：半透明深色+毛玻璃 */
        .human {
            padding: 15px;
            background: rgba(20, 25, 40, 0.8); /* 半透明背景 */
            backdrop-filter: blur(10px); /* 毛玻璃 */
            border-top: 1px solid rgba(255, 255, 255, 0.08); /* 上边框分隔 */
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .question {
            flex: 1;
            height: auto;
            min-height: 40px;
            max-height: 150px;
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1); /* 浅色边框 */
            border-radius: 20px;
            outline: none;
            resize: none;
            font-size: 14px;
            line-height: 1.5;
            background: rgba(30, 35, 55, 0.6); /* 输入框半透明背景 */
            color: #e5e5e5; /* 输入框文字颜色 */
            backdrop-filter: blur(5px);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        /* 输入框聚焦样式 */
        .question:focus {
            border-color: #4d7cff; /* 高亮边框 */
            box-shadow: 0 0 0 2px rgba(77, 124, 255, 0.2); /* 高亮阴影 */
        }

        /* 输入框占位符颜色 */
        .question::placeholder {
            color: #777;
        }

        .ques {
            width: 80px;
            height: 40px;
            background: #4d7cff; /* 按钮主色（深色适配） */
            color: #fff;
            border: none;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s, transform 0.2s;
        }

        .ques:hover {
            background: #3a66e0; /* 按钮hover色 */
            transform: scale(1.02); /* 轻微放大 */
        }

        .ques:disabled {
            background: #444; /* 禁用状态颜色 */
            cursor: not-allowed;
            transform: none;
        }

        /* 思考动画样式（深色适配） */
        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #aaa; /* 浅色圆点（深色背景下更明显） */
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* 媒体查询 - 移动端适配 */
        @media (max-width: 768px) {
            .container {
                width: 95%; /* 移动端更宽的占比 */
                height: calc(100vh - 20px); /* 减少上下内边距 */
            }

            .answer {
                max-width: 85%;
            }

            .ai img, .people img {
                width: 36px;
                height: 36px;
            }

            .human {
                padding: 10px 15px;
            }

            .question {
                min-height: 36px;
            }

            .ques {
                width: 70px;
                height: 36px;
            }
        }

        /* PC端适配（可选，可根据需求调整） */
        @media (min-width: 900px) {
            .container {
                max-width: 900px; /* 大屏下稍宽 */
            }

            .answer {
                max-width: 60%;
            }

            .answer span:last-child {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="bck-filter"></div>
    <div class="container">
        <main class="main"></main>
        <div class="human">
            <textarea class="question" placeholder="请输入发送内容..." required></textarea>
            <button type="submit" class="ques">
                <svg t="1739275555700" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4467" width="16" height="16">
                    <path d="M933.546667 198.826667c-9.045333-13.653333-21.504-9.045333-22.528-8.874667L102.912 390.997333c-7.509333 1.877333-13.312 7.68-15.36 15.018667-2.048 7.509333 0 15.36 5.461333 20.821333l152.405333 151.552 43.690667 238.933333c0 0.512 1.706667 14.165333 16.042667 16.896 11.946667 2.218667 17.92-3.754667 18.261333-3.925333l97.450667-77.482667 76.288 75.946667c4.608 4.437333 10.752 6.826667 17.066667 6.144 6.314667-0.682667 11.946667-3.925333 15.701333-9.386667l403.968-602.794667C934.4 221.866667 941.226667 210.602667 933.546667 198.826667zM150.016 423.253333l611.84-152.064L268.970667 541.525333 150.016 423.253333zM314.538667 718.677333l-25.429333-139.434667 348.16-190.976L353.621333 595.456c0 0-3.754667 3.072-5.290667 5.12-1.365333 1.877333-2.730667 6.314667-2.730667 6.314667L314.538667 718.677333zM370.858667 675.84l30.890667 37.717333-53.248 42.325333L370.858667 675.84zM509.952 778.581333l-125.098667-153.088 0 0L831.146667 299.349333 509.952 778.581333z" p-id="4468" fill="#fff"></path>
                </svg>
                <span>发送</span>
            </button>
        </div>
    </div>

    <script>
        // 工具函数：格式化时间
        function formatTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 月份从0开始，补0
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        // 全局变量：存储message事件的源和origin（用于回传消息）
        let messageSource = null;
        let messageOrigin = null;

        // 历史消息数组
        const history_message = [];
        const mainEl = document.querySelector('.main');
        const questionEl = document.querySelector('.question');
        const sendBtnEl = document.querySelector('.ques');

        // 初始化AI欢迎消息
        const initTime = new Date();
        renderMessage('ai', '你好，我是你的AI助手小言，请问有什么可以帮助你的吗？', initTime);

        // 渲染消息函数
        function renderMessage(role, content, time, isLoading = false) {
            const timeStr = formatTime(time);
            let html = '';

            if (role === 'ai') {
                html = `
                    <div class="ai ${isLoading ? 'ai-loading' : ''}">
                        <img src="./img/ai.jpg" alt="AI头像">
                        <div class="answer">
                            <span>${timeStr}</span>
                            <span>${isLoading ? '<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>' : content}</span>
                        </div>
                    </div>
                `;
            } else if (role === 'user') {
                html = `
                    <div class="people">
                        <img src="./img/human.jpg" alt="用户头像">
                        <div class="answer">
                            <span>${timeStr}</span>
                            <span>${content}</span>
                        </div>
                    </div>
                `;
            }

            mainEl.innerHTML += html;
            // 自动滚动到底部
            mainEl.scrollTop = mainEl.scrollHeight;
        }

        // 移除加载动画并替换为AI回答，同时回传消息给外部
        function updateAiMessage(content, time) {
            const loadingEl = mainEl.querySelector('.ai-loading');
            if (loadingEl) {
                const timeStr = formatTime(time);
                loadingEl.innerHTML = `
                    <img src="./img/ai.jpg" alt="AI头像">
                    <div class="answer">
                        <span>${timeStr}</span>
                        <span>${content}</span>
                    </div>
                `;
                loadingEl.classList.remove('ai-loading');
                // 自动滚动到底部
                mainEl.scrollTop = mainEl.scrollHeight;
            }

            // 若存在外部消息源，则回传AI的回答
            if (messageSource) {
                messageSource.postMessage(content, messageOrigin);
                // 回传后重置（可选：如果需要持续接收消息，可保留不重置）
                // messageSource = null;
                // messageOrigin = null;
            }
        }

        // 发送消息处理函数
        function sendMessage() {
            const text = questionEl.value.trim();
            // 验证输入：非空且不是纯空格
            if (!text) return;

            // 清空输入框
            questionEl.value = '';
            const currentTime = new Date();

            // 渲染用户消息
            renderMessage('user', text, currentTime);
            // 添加到历史消息
            history_message.push({
                role: 'user',
                content: text,
            });

            // 渲染AI加载状态
            renderMessage('ai', '', currentTime, true);
            // 禁用发送按钮
            sendBtnEl.disabled = true;

            // 发送请求到DeepSeek API
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://api.deepseek.com/chat/completions');
            xhr.setRequestHeader('Content-Type', 'application/json');
            // 注意：实际项目中请将API Key存储在后端，前端通过接口调用，避免泄露
            xhr.setRequestHeader('Authorization', 'Bearer sk-fbbe4c4f9ba14e629377397cb667b6b8');

            xhr.addEventListener('loadend', () => {
                // 启用发送按钮
                sendBtnEl.disabled = false;
                try {
                    const response = JSON.parse(xhr.response);
                    const aiContent = response.choices[0].message.content;
                    // 添加到历史消息
                    history_message.push({
                        role: 'assistant',
                        content: aiContent,
                    });
                    // 更新AI消息（替换加载动画）并回传消息
                    updateAiMessage(aiContent, currentTime);
                } catch (error) {
                    // 错误处理
                    const errorMsg = '抱歉，我现在有点忙，请稍后再试～';
                    updateAiMessage(errorMsg, currentTime);
                    console.error('请求失败：', error);
                }
            });

            // 请求参数
            const data = {
                "model": "deepseek-chat",
                "frequency_penalty": 0,
                "max_tokens": 2048,
                "presence_penalty": 0,
                "response_format": {
                    "type": "text"
                },
                "stop": null,
                "stream": false,
                "stream_options": null,
                "temperature": 1,
                "top_p": 1,
                "tools": null,
                "tool_choice": "none",
                "logprobs": false,
                "top_logprobs": null,
                "messages": [...history_message]
            };

            xhr.send(JSON.stringify(data));
        }

        // 绑定发送按钮点击事件
        sendBtnEl.addEventListener('click', sendMessage);

        // 绑定输入框回车发送（排除shift+回车）
        questionEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 阻止换行
                sendMessage();
            }
        });

        // 监听message事件，接收外部传来的消息
        window.addEventListener("message", function(event) {
            // 保存消息源和origin（用于回传）
            messageSource = event.source;
            messageOrigin = event.origin;
            // 将外部消息填入输入框
            questionEl.value = event.data;
            // 自动发送消息给AI
            sendMessage();
            console.log('收到外部消息：', event.data);
        }, false);
    </script>
</body>
</html>